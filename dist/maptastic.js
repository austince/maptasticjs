!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("numeric")):"function"==typeof define&&define.amd?define(["exports","numeric"],e):e((t=t||self).maptastic={},t.numeric)}(this,function(t,B){"use strict";t.Maptastic=function(t){function e(t,e,i){return t&&t.hasOwnProperty(e)&&null!==t[e]?t[e]:i}function d(t,e,i,n){return Math.sqrt(Math.pow(i-t,2)+Math.pow(n-e,2))}function P(t,e,i,n){var o=e[1]*n[0]-e[0]*n[1]+(n[1]-e[1])*t[0]+(e[0]-n[0])*t[1],r=e[0]*i[1]-e[1]*i[0]+(e[1]-i[1])*t[0]+(i[0]-e[0])*t[1];if(o<0!=r<0)return!1;var s=-i[1]*n[0]+e[1]*(n[0]-i[0])+e[0]*(i[1]-n[1])+i[0]*n[1];return s<0&&(o=-o,r=-r,s=-s),0<o&&0<r&&o+r<s}function v(){o()}function y(){if(T){g.strokeStyle="red",g.lineWidth=2,g.clearRect(0,0,k.width,k.height);for(var t=0;t<x.length;t++)if(x[t].visible){x[t].element.style.visibility="visible",g.beginPath(),g.strokeStyle=x[t]===I?"red":x[t]===M?"red":"white",g.moveTo(x[t].targetPoints[0][0],x[t].targetPoints[0][1]);for(var e=0;e<x[t].targetPoints.length;e++)g.lineTo(x[t].targetPoints[e][0],x[t].targetPoints[e][1]);g.lineTo(x[t].targetPoints[3][0],x[t].targetPoints[3][1]),g.closePath(),g.stroke();var i=[0,0];for(e=0;e<x[t].targetPoints.length;e++)g.strokeStyle=x[t].targetPoints[e]===L?"red":x[t].targetPoints[e]===E?"red":"white",i[0]+=x[t].targetPoints[e][0],i[1]+=x[t].targetPoints[e][1],g.beginPath(),g.arc(x[t].targetPoints[e][0],x[t].targetPoints[e][1],10,0,2*Math.PI,!1),g.stroke();if(i[0]/=4,i[1]/=4,l){var n=x[t].element.id.toUpperCase();g.font="16px sans-serif",g.textAlign="center";var o=[g.measureText(n).width+8,32];g.fillStyle="white",g.fillRect(i[0]-o[0]/2,i[1]-o[1]+8,o[0],o[1]),g.fillStyle="black",g.fillText(n,i[0],i[1])}}else x[t].element.style.visibility="hidden";if(w&&(g.strokeStyle="yellow",g.lineWidth=1,g.beginPath(),g.moveTo(C[0],0),g.lineTo(C[0],k.height),g.moveTo(0,C[1]),g.lineTo(k.width,C[1]),g.stroke()),f){g.fillStyle="black",g.lineWidth=4,g.fillRect(0,0,k.width,k.height),g.strokeStyle="#909090",g.beginPath();var r=k.width/10,s=k.height/10;for(t=0;t<10;t++)g.moveTo(t*r,0),g.lineTo(t*r,k.height),g.moveTo(0,t*s),g.lineTo(k.width,t*s);g.stroke(),g.strokeStyle="white",g.strokeRect(2,2,k.width-4,k.height-4);var a=Math.round(.6*s);g.font=a+"px mono,sans-serif",g.fillRect(2*r+2,3*s+2,k.width-4*r-4,k.height-6*s-4),g.fillStyle="white",g.fontSize=20,g.fillText(k.width+" x "+k.height,k.width/2,k.height/2+.75*a),g.fillText("display size",k.width/2,k.height/2-.75*a)}}}function r(t,e,i){var n=t[e][0],o=t[e][1];t[e][0]=t[i][0],t[e][1]=t[i][1],t[i][0]=n,t[i][1]=o}function p(t,e){for(var i=Math.sin(e),n=Math.cos(e),o=[0,0],r=0;r<t.targetPoints.length;r++)o[0]+=t.targetPoints[r][0],o[1]+=t.targetPoints[r][1];for(o[0]/=4,o[1]/=4,r=0;r<t.targetPoints.length;r++){var s=t.targetPoints[r][0]-o[0],a=t.targetPoints[r][1]-o[1];t.targetPoints[r][0]=s*n-a*i+o[0],t.targetPoints[r][1]=s*i+a*n+o[1]}}function m(t,e){for(var i=[0,0],n=0;n<t.targetPoints.length;n++)i[0]+=t.targetPoints[n][0],i[1]+=t.targetPoints[n][1];for(i[0]/=4,i[1]/=4,n=0;n<t.targetPoints.length;n++){var o=t.targetPoints[n][1]-i[1];t.targetPoints[n][0]=(t.targetPoints[n][0]-i[0])*e+i[0],t.targetPoints[n][1]=o*e+i[1]}}function s(t,e){var i;if("string"==typeof t){if(!(i=document.getElementById(t)))throw"Maptastic: No element found with id: "+t}else t instanceof HTMLElement&&(i=t);for(var n=0;n<x.length;n++)x[n].element.id==i.id&&(x[n].targetPoints=j(layout[a].targetPoints));var o=i.offsetLeft,r=i.offsetTop;i.style.position="fixed",i.style.display="block",i.style.top="0px",i.style.left="0px",i.style.padding="0px",i.style.margin="0px";var s={visible:!0,element:i,width:i.clientWidth,height:i.clientHeight,sourcePoints:[],targetPoints:[]};if(s.sourcePoints.push([0,0],[s.width,0],[s.width,s.height],[0,s.height]),e)s.targetPoints=j(e);else{s.targetPoints.push([0,0],[s.width,0],[s.width,s.height],[0,s.height]);for(var a=0;a<s.targetPoints.length;a++)s.targetPoints[a][0]+=o,s.targetPoints[a][1]+=r}x.push(s),Y()}var l=e(t,"labels",!0),w=e(t,"crosshairs",!1),f=e(t,"screenbounds",!1),b=e(t,"autoSave",!0),i=e(t,"autoLoad",!0),n=e(t,"layers",[]),o=e(t,"onchange",function(){}),a="maptastic.layers",k=null,g=null,x=[],T=!1,S=!1,h=[],M=null,E=null,L=null,I=null,c=!1,C=[],K=[],u=[],z=function(t){if(!T)return 32==t.keyCode&&t.shiftKey?void O(!0):void 0;var e=t.shiftKey?10:1,i=!1,n=[0,0];switch(t.keyCode){case 32:if(t.shiftKey)return void O(!1);break;case 37:n[0]-=e;break;case 38:n[1]-=e;break;case 39:n[0]+=e;break;case 40:n[1]+=e;break;case 67:w=!w,i=!0;break;case 83:if(c){for(o=0;o<x.length;o++)x[o].visible=!0;i=!(c=!1)}else if(null!=M){for(var o=0;o<x.length;o++)x[o].visible=!1;c=i=M.visible=!0}break;case 66:f=!f,y();break;case 72:M&&(r(M.sourcePoints,0,1),r(M.sourcePoints,3,2),Y(),y());break;case 86:M&&(r(M.sourcePoints,0,3),r(M.sourcePoints,1,2),Y(),y());break;case 82:M&&(p(M,Math.PI/2),Y(),y())}if(!f)if(E)E[0]+=n[0],E[1]+=n[1],i=!0;else if(M){if(1==t.altKey)p(M,.01*n[0]),m(M,-.005*n[1]+1);else for(o=0;o<M.targetPoints.length;o++)M.targetPoints[o][0]+=n[0],M.targetPoints[o][1]+=n[1];i=!0}i&&(Y(),y(),b&&X(),v())},H=function(t){var e,i,n,o;if(T)if(t.preventDefault(),K[0]=t.clientX-C[0],K[1]=t.clientY-C[1],C[0]=t.clientX,C[1]=t.clientY,S){var r=t.shiftKey?.1:1;if(E)E[0]+=K[0]*r,E[1]+=K[1]*r;else if(M)if(1==t.altKey)p(M,K[0]*(.01*r)),m(M,K[1]*(-.005*r)+1);else for(var s=0;s<M.targetPoints.length;s++)M.targetPoints[s][0]+=K[0]*r,M.targetPoints[s][1]+=K[1]*r;Y(),b&&X(),y(),v()}else{k.style.cursor="default";var a=t.clientX,l=t.clientY,f=null!=L,g=null!=I;L=null;for(s=0;s<x.length;s++){var h=x[s];if(h.visible)for(var c=0;c<h.targetPoints.length;c++){var u=h.targetPoints[c];if(d(u[0],u[1],a,l)<20){k.style.cursor="pointer",L=u;break}}}I=null;for(s=0;s<x.length;s++)if(x[s].visible&&(void 0,n=P(e=C,(i=x[s]).targetPoints[0],i.targetPoints[1],i.targetPoints[2]),o=P(e,i.targetPoints[3],i.targetPoints[0],i.targetPoints[2]),n||o)){I=x[s];break}!w&&f==(null!=L)&&g==(null!=I)||y()}},R=function(t){T&&(t.preventDefault(),S=!1)},W=function(t){if(T&&!f){t.preventDefault(),L=null,I?(M=I,S=!0):M=null,E=null;var e=t.clientX,i=t.clientY;u[0]=e,u[1]=i;for(var n=0;n<x.length;n++)for(var o=x[n],r=0;r<o.targetPoints.length;r++){var s=o.targetPoints[r];if(d(s[0],s[1],e,i)<20){M=o,S=!0,h[0]=t.clientX-(E=s)[0],h[1]=t.clientY-s[1];break}}return y(),!1}},X=function(){localStorage.setItem(a,JSON.stringify(N()))},Y=function(){for(var t=["","-webkit-","-moz-","-ms-","-o-"].reduce(function(t,e){return e+"transform"in document.body.style?e:t})+"transform",e=0;e<x.length;e++){for(var i=[],n=[],o=0,r=x[e].sourcePoints.length;o<r;++o){var s=x[e].sourcePoints[o],a=x[e].targetPoints[o];i.push([s[0],s[1],1,0,0,0,-s[0]*a[0],-s[1]*a[0]]),n.push(a[0]),i.push([0,0,0,s[0],s[1],1,-s[0]*a[1],-s[1]*a[1]]),n.push(a[1])}var l=B.solve(i,n,!0);x[e].element.style[t]="matrix3d("+[l[0],l[3],0,l[6],l[1],l[4],0,l[7],0,0,1,0,l[2],l[5],0,1].join(",")+")",x[e].element.style[t+"-origin"]="0px 0px 0px"}},O=function(t){k.style.display=(T=t)?"block":"none",t?y():(M=E=null,f=S=!1)},j=function(t){for(var e=[],i=0;i<t.length;i++)e.push(t[i].slice(0,2));return e},D=function(){k.width=window.innerWidth,k.height=window.innerHeight,y()},N=function(){for(var t=[],e=0;e<x.length;e++)t.push({id:x[e].element.id,targetPoints:j(x[e].targetPoints),sourcePoints:j(x[e].sourcePoints)});return t};(k=document.createElement("canvas")).style.display="none",k.style.position="fixed",k.style.top="0px",k.style.left="0px",k.style.zIndex="1000000",g=k.getContext("2d"),document.body.appendChild(k),window.addEventListener("resize",D),window.addEventListener("mousemove",H),window.addEventListener("mouseup",R),window.addEventListener("mousedown",W),window.addEventListener("keydown",z),D();for(var q=0;q<n.length;q++)(n[q]instanceof HTMLElement||"string"==typeof n[q])&&s(n[q]);for(q=0;q<arguments.length;q++)(arguments[q]instanceof HTMLElement||"string"==typeof arguments[q])&&s(arguments[q]);return i&&function(){if(localStorage.getItem(a)){for(var t=JSON.parse(localStorage.getItem(a)),e=0;e<t.length;e++)for(var i=0;i<x.length;i++)x[i].element.id==t[e].id&&(x[i].targetPoints=j(t[e].targetPoints),x[i].sourcePoints=j(t[e].sourcePoints));Y()}}(),{getLayout:function(){return N()},setLayout:function(t){!function(t){for(var e=0;e<t.length;e++){for(var i=!1,n=0;n<x.length;n++)x[n].element.id==t[e].id&&(console.log("Setting points."),x[n].targetPoints=j(t[e].targetPoints),x[n].sourcePoints=j(t[e].sourcePoints),i=!0);if(i)console.log("Maptastic: Element '"+t[e].id+"' is already mapped.");else{var o=document.getElementById(t[e].id);o?s(o,t[e].targetPoints):console.log("Maptastic: Can't find element: "+t[e].id)}}Y(),y()}(t)},setConfigEnabled:function(t){O(t)},addLayer:function(t,e){s(t,e)}}},Object.defineProperty(t,"__esModule",{value:!0})});
//# sourceMappingURL=maptastic.js.map
