{"version":3,"sources":["../build/maptastic.js"],"names":["Maptastic","r","t","n","o","e","length","f","u","c","Array","push","a","h","i","l","g","v","y","b","LU","P","Math","abs","solve","config","getProp","cfg","key","defaultVal","hasOwnProperty","showLayerNames","showCrosshairs","showScreenBounds","autoSave","autoLoad","layerList","layoutChangeListener","localStorageKey","canvas","context","layers","configActive","dragging","dragOffset","selectedLayer","selectedPoint","selectionRadius","hoveringPoint","hoveringLayer","dragOperation","isLayerSoloed","mousePosition","mouseDelta","mouseDownPoint","distanceTo","x1","y1","x2","y2","sqrt","pow","pointInTriangle","point","s","A","pointInLayer","layer","targetPoints","notifyChangeListener","draw","strokeStyle","lineWidth","clearRect","width","height","visible","element","style","visibility","beginPath","moveTo","p","lineTo","closePath","stroke","centerPoint","arc","PI","label","id","toUpperCase","font","textAlign","metrics","measureText","size","fillStyle","fillRect","fillText","stepX","stepY","strokeRect","fontSize","round","swapLayerPoints","layerPoints","index1","index2","tx","ty","init","document","createElement","display","position","top","left","zIndex","getContext","body","appendChild","window","addEventListener","resize","mouseMove","mouseUp","mouseDown","keyDown","rotateLayer","angle","sin","cos","px","py","scaleLayer","scale","event","keyCode","shiftKey","setConfigEnabled","increment","dirty","delta","console","log","sourcePoints","updateTransform","altKey","saveSettings","preventDefault","clientX","clientY","cursor","mouseX","mouseY","previousState","previousLayer","addLayer","target","getElementById","HTMLElement","exists","clonePoints","layout","offsetX","offsetLeft","offsetY","offsetTop","padding","margin","clientWidth","clientHeight","localStorage","setItem","JSON","stringify","getLayout","loadSettings","getItem","data","parse","transform","reduce","X","matrix","join","enabled","points","clone","slice","innerWidth","innerHeight","setLayout","arguments"],"mappings":"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","file":"maptastic.js","sourcesContent":["/*\nNumeric Javascript\nCopyright (C) 2011 by Sébastien Loisel\n\nPermission is hereby granted, free of charge, to any person obtaining a copy\nof this software and associated documentation files (the \"Software\"), to deal\nin the Software without restriction, including without limitation the rights\nto use, copy, modify, merge, publish, distribute, sublicense, and/or sell\ncopies of the Software, and to permit persons to whom the Software is\nfurnished to do so, subject to the following conditions:\n\nThe above copyright notice and this permission notice shall be included in\nall copies or substantial portions of the Software.\n\nTHE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\nIMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\nFITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\nAUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\nLIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\nOUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\nTHE SOFTWARE.\n*/\n!function(){function r(t,n,o,e){if(o===n.length-1)return e(t);var f,u=n[o],c=Array(u);for(f=u-1;f>=0;--f)c[f]=r(t[f],n,o+1,e);return c}function t(r){for(var t=[];\"object\"==typeof r;)t.push(r.length),r=r[0];return t}function n(r){var n,o;return\"object\"==typeof r?(n=r[0],\"object\"==typeof n?(o=n[0],\"object\"==typeof o?t(r):[r.length,n.length]):[r.length]):[]}function o(r){var t,n=r.length,o=Array(n);for(t=n-1;-1!==t;--t)o[t]=r[t];return o}function e(t){return\"object\"!=typeof t?t:r(t,n(t),0,o)}function f(r,t){t=t||!1;var n,o,f,u,a,h,i,l,g,v=r.length,y=v-1,b=new Array(v);for(t||(r=e(r)),f=0;v>f;++f){for(i=f,h=r[f],g=c(h[f]),o=f+1;v>o;++o)u=c(r[o][f]),u>g&&(g=u,i=o);for(b[f]=i,i!=f&&(r[f]=r[i],r[i]=h,h=r[f]),a=h[f],n=f+1;v>n;++n)r[n][f]/=a;for(n=f+1;v>n;++n){for(l=r[n],o=f+1;y>o;++o)l[o]-=l[f]*h[o],++o,l[o]-=l[f]*h[o];o===y&&(l[o]-=l[f]*h[o])}}return{LU:r,P:b}}function u(r,t){var n,o,f,u,c,a=r.LU,h=a.length,i=e(t),l=r.P;for(n=h-1;-1!==n;--n)i[n]=t[n];for(n=0;h>n;++n)for(f=l[n],l[n]!==n&&(c=i[n],i[n]=i[f],i[f]=c),u=a[n],o=0;n>o;++o)i[n]-=i[o]*u[o];for(n=h-1;n>=0;--n){for(u=a[n],o=n+1;h>o;++o)i[n]-=i[o]*u[o];i[n]/=u[n]}return i}var c=Math.abs;solve=function(r,t,n){return u(f(r,n),t)}}();\n\n\nexport default function Maptastic(config) {\n\n  var getProp = function(cfg, key, defaultVal){\n    if(cfg && cfg.hasOwnProperty(key) && (cfg[key] !== null)) {\n      return cfg[key];\n    } else {\n      return defaultVal;\n    }\n  }\n\n  var showLayerNames       = getProp(config, 'labels', true);\n  var showCrosshairs       = getProp(config, 'crosshairs', false);\n  var showScreenBounds     = getProp(config, 'screenbounds', false);\n  var autoSave             = getProp(config, 'autoSave', true);\n  var autoLoad             = getProp(config, 'autoLoad', true);\n  var layerList            = getProp(config, 'layers', []);\n  var layoutChangeListener = getProp(config, 'onchange', function(){} );\n  var localStorageKey      = 'maptastic.layers';\n\n  var canvas = null;\n  var context = null;\n\n  var layers = [];\n\n  var configActive = false;\n\n  var dragging = false;\n  var dragOffset = [];\n\n  var selectedLayer = null;\n  var selectedPoint = null;\n  var selectionRadius = 20;\n  var hoveringPoint = null;\n  var hoveringLayer = null;\n  var dragOperation = \"move\";\n  var isLayerSoloed = false;\n\n  var mousePosition = [];\n  var mouseDelta = [];\n  var mouseDownPoint = [];\n\n\t// Compute linear distance.\n\tvar distanceTo = function(x1, y1, x2, y2) {\n\t  return Math.sqrt(Math.pow(x2 - x1, 2) + Math.pow(y2 - y1, 2));\n\t}\n\n  var pointInTriangle = function(point, a, b, c) {\n\t\tvar s = a[1] * c[0] - a[0] * c[1] + (c[1] - a[1]) * point[0] + (a[0] - c[0]) * point[1];\n\t\tvar t = a[0] * b[1] - a[1] * b[0] + (a[1] - b[1]) * point[0] + (b[0] - a[0]) * point[1];\n\n\t\tif ((s < 0) != (t < 0)) {\n\t\treturn false;\n\t\t}\n\n\t\tvar A = -b[1] * c[0] + a[1] * (c[0] - b[0]) + a[0] * (b[1] - c[1]) + b[0] * c[1];\n\t\tif (A < 0.0) {\n\t\ts = -s;\n\t\tt = -t;\n\t\tA = -A;\n\t\t}\n\n\t\treturn s > 0 && t > 0 && (s + t) < A;\n\t};\n\n\t// determine if a point is inside a layer quad.\n\tvar pointInLayer = function(point, layer) {\n\t  var a = pointInTriangle(point, layer.targetPoints[0], layer.targetPoints[1], layer.targetPoints[2]);\n\t  var b = pointInTriangle(point, layer.targetPoints[3], layer.targetPoints[0], layer.targetPoints[2]);\n\t  return a || b;\n\t};\n\n  var notifyChangeListener = function() {\n    layoutChangeListener();\n  };\n\n\tvar draw = function() {\n\t  if(!configActive){\n\t    return;\n\t  }\n\t  \n\t  context.strokeStyle = \"red\";\n\t  context.lineWidth = 2;\n\t  context.clearRect(0, 0, canvas.width, canvas.height);\t  \n\t  \n\t  for(var i = 0; i < layers.length; i++) {\n\t    \n\t  \tif(layers[i].visible){\n\t  \t\tlayers[i].element.style.visibility = \"visible\";\n\n\t\t    // Draw layer rectangles.\n\t\t    context.beginPath();\n\t\t    if(layers[i] === hoveringLayer){\n\t\t      context.strokeStyle = \"red\";\n\t\t    } else if(layers[i] === selectedLayer){\n\t\t      context.strokeStyle = \"red\";\n\t\t    } else {\n\t\t      context.strokeStyle = \"white\";\n\t\t    }\n\t\t    context.moveTo(layers[i].targetPoints[0][0], layers[i].targetPoints[0][1]);\n\t\t    for(var p = 0; p < layers[i].targetPoints.length; p++) {\n\t\t      context.lineTo(layers[i].targetPoints[p][0], layers[i].targetPoints[p][1]);\n\t\t    }\n\t\t    context.lineTo(layers[i].targetPoints[3][0], layers[i].targetPoints[3][1]);\n\t\t    context.closePath();\n\t\t    context.stroke();\n\n\t\t    // Draw corner points.\n\t\t    var centerPoint = [0,0];\n\t\t    for(var p = 0; p < layers[i].targetPoints.length; p++) {\n\n\t\t      if(layers[i].targetPoints[p] === hoveringPoint){\n\t\t        context.strokeStyle = \"red\";\n\t\t      } else if( layers[i].targetPoints[p] === selectedPoint ) {\n\t\t        context.strokeStyle = \"red\";\n\t\t      } else {\n\t\t        context.strokeStyle = \"white\";\n\t\t      }\n\t\t      \n\t\t      centerPoint[0] += layers[i].targetPoints[p][0];\n\t\t      centerPoint[1] += layers[i].targetPoints[p][1];\n\t\t      \n\t\t      context.beginPath();\n\t\t      context.arc(layers[i].targetPoints[p][0], layers[i].targetPoints[p][1],\n\t\t        selectionRadius / 2, 0, 2 * Math.PI, false);\n\t\t      context.stroke();\n\t\t    }\n\n\t\t    // Find the average of the corner locations for an approximate center.\n\t\t    centerPoint[0] /= 4;\n\t\t    centerPoint[1] /= 4;\n\n\n\t\t    if(showLayerNames) {\n\t\t      // Draw the element ID in the center of the quad for reference.\n\t\t      var label = layers[i].element.id.toUpperCase();\n\t\t      context.font=\"16px sans-serif\";\n\t\t      context.textAlign = \"center\";\n\t\t      var metrics = context.measureText(label);\n\t\t      var size = [metrics.width + 8, 16 + 16]\n\t\t      context.fillStyle = \"white\";\n\t\t      context.fillRect(centerPoint[0] - size[0] / 2, centerPoint[1] - size[1] + 8, size[0], size[1]);\n\t\t      context.fillStyle = \"black\";\n\t\t      context.fillText(label, centerPoint[0], centerPoint[1]);\n\t\t    }\n\t    } else {\n\t  \t\tlayers[i].element.style.visibility = \"hidden\";\n\t  \t}\n\t  }\n\n\t  // Draw mouse crosshairs\n\t  if(showCrosshairs) {\n\t    context.strokeStyle = \"yellow\";\n\t    context.lineWidth = 1;\n\t    \n\t    context.beginPath();\n\t    \n\t    context.moveTo(mousePosition[0], 0);\n\t    context.lineTo(mousePosition[0], canvas.height);\n\n\t    context.moveTo(0, mousePosition[1]);\n\t    context.lineTo(canvas.width, mousePosition[1]);\n\t    \n\t    context.stroke();\n\t  }\n\n\t  if(showScreenBounds) {\n\n\t  \tcontext.fillStyle = \"black\";\n\t    context.lineWidth = 4;\n\t  \tcontext.fillRect(0,0,canvas.width,canvas.height);\n\t  \t\n\t  \tcontext.strokeStyle = \"#909090\";\n\t  \tcontext.beginPath();\n\t  \tvar stepX = canvas.width / 10;\n\t  \tvar stepY = canvas.height / 10;\n\n\t  \tfor(var i = 0; i < 10; i++) {\n\t  \t\tcontext.moveTo(i * stepX, 0);\n\t    \tcontext.lineTo(i * stepX, canvas.height);\n\n\t    \tcontext.moveTo(0, i * stepY);\n\t    \tcontext.lineTo(canvas.width, i * stepY);\n\t\t\t}\n\t    context.stroke();\n\t\t\t\n\t\t\tcontext.strokeStyle = \"white\";\n\t    context.strokeRect(2, 2, canvas.width-4,canvas.height-4);\n\n\t    var fontSize = Math.round(stepY * 0.6);\n\t    context.font = fontSize + \"px mono,sans-serif\";\n\t    context.fillRect(stepX*2+2, stepY*3+2, canvas.width-stepX*4-4, canvas.height-stepY*6-4);\n\t    context.fillStyle = \"white\";\n\t    context.fontSize = 20;\n\t    context.fillText(canvas.width + \" x \" + canvas.height, canvas.width/2, canvas.height/2 + (fontSize * 0.75));\n\t    context.fillText('display size', canvas.width/2, canvas.height/2 - (fontSize * 0.75));\n\t  }\n\t};\n\n\tvar swapLayerPoints = function(layerPoints, index1, index2){\n\t\tvar tx = layerPoints[index1][0];\n\t\tvar ty = layerPoints[index1][1];\n\t\tlayerPoints[index1][0] = layerPoints[index2][0];\n\t\tlayerPoints[index1][1] = layerPoints[index2][1];\n\t\tlayerPoints[index2][0] = tx;\n\t\tlayerPoints[index2][1] = ty;\n\t}\n\n\tvar init = function(){\n\t  canvas = document.createElement('canvas');\n\t  \n\t  canvas.style.display = 'none';\n\t  canvas.style.position = 'fixed';\n\t  canvas.style.top = '0px';\n\t  canvas.style.left = '0px';\n\t  canvas.style.zIndex = '1000000';\n\n\t  context = canvas.getContext('2d');\n\n\t  document.body.appendChild(canvas);\n\t  \n\t  window.addEventListener('resize', resize );\n\t  \n\t  // UI events\n\t  window.addEventListener('mousemove', mouseMove);\n\t  window.addEventListener('mouseup', mouseUp);\n\t  window.addEventListener('mousedown', mouseDown);\n\t  window.addEventListener('keydown', keyDown);\n\n\t  resize();\n\t};\n\n\tvar rotateLayer = function(layer, angle) {\n\t\tvar s = Math.sin(angle);\n\t\tvar c = Math.cos(angle);\n\n\t\tvar centerPoint = [0, 0];\n    for(var p = 0; p < layer.targetPoints.length; p++) {\n      centerPoint[0] += layer.targetPoints[p][0];\n      centerPoint[1] += layer.targetPoints[p][1];\n    }\n\n    centerPoint[0] /= 4;\n    centerPoint[1] /= 4;\n\n    for(var p = 0; p < layer.targetPoints.length; p++) {\n    \tvar px = layer.targetPoints[p][0] - centerPoint[0];\n    \tvar py = layer.targetPoints[p][1] - centerPoint[1];\n\n\t\t\tlayer.targetPoints[p][0] = (px * c) - (py * s) + centerPoint[0];\n    \tlayer.targetPoints[p][1] = (px * s) + (py * c) + centerPoint[1];\n    }\n\t}\n\n\tvar scaleLayer = function(layer, scale) {\n\n\t\tvar centerPoint = [0, 0];\n    for(var p = 0; p < layer.targetPoints.length; p++) {\n      centerPoint[0] += layer.targetPoints[p][0];\n      centerPoint[1] += layer.targetPoints[p][1];\n    }\n\n    centerPoint[0] /= 4;\n    centerPoint[1] /= 4;\n\n    for(var p = 0; p < layer.targetPoints.length; p++) {\n    \tvar px = layer.targetPoints[p][0] - centerPoint[0];\n    \tvar py = layer.targetPoints[p][1] - centerPoint[1];\n\n\t\t\tlayer.targetPoints[p][0] = (px * scale) + centerPoint[0];\n    \tlayer.targetPoints[p][1] = (py * scale) + centerPoint[1];\n    }\n\t}\n\n\tvar keyDown = function(event) {\n\t  if(!configActive){\n\t    if(event.keyCode == 32 && event.shiftKey){\n\t      setConfigEnabled(true);\n\t      return;\n\t    } else {\n\t      return;\n\t    }\n\t  }\n\n\t  var key = event.keyCode;\n\n\t  var increment = event.shiftKey ? 10 : 1;\n\t  var dirty = false;\n\t  var delta = [0, 0];\n\n\t  console.log(key);\n\t  switch(key){\n\n\t    case 32: // spacebar\n\t      if(event.shiftKey){\n\t        setConfigEnabled(false);\n\t        return;\n\t      }\n\t    break;\n\n\t    case 37: // left arrow\n\t      delta[0] -= increment;\n\t    break;\n\n\t    case 38: // up arrow\n\t      delta[1] -= increment;\n\t    break;\n\n\t    case 39: // right arrow\n\t      delta[0] += increment;\n\t    break;\n\n\t    case 40: // down arrow\n\t      delta[1] += increment;\n\t    break;\n\n\t    case 67: // c key, toggle crosshairs\n\t      showCrosshairs = !showCrosshairs;\n\t      dirty = true;\n\t    break;\n\n\t    case 83: // s key, solo/unsolo quads\n\t      if(!isLayerSoloed) {\n\n\t      \tif(selectedLayer != null) {\n\t\t      \tfor(var i = 0; i < layers.length; i++){\n\t\t      \t\tlayers[i].visible = false;\n\t\t      \t}\n\t\t      \tselectedLayer.visible = true;\n\t\t      \tdirty = true;\n\t\t      \tisLayerSoloed = true;\n\t\t      }\n\t      } else {\n\t      \tfor(var i = 0; i < layers.length; i++){\n\t\t      \t\tlayers[i].visible = true;\n\t\t      \t}\n\t      \tisLayerSoloed = false;\n\t      \tdirty = true;\n\n\t      }\n\t    break;\n\n\t    case 66: // b key, toggle projector bounds rectangle.\n\t    \tshowScreenBounds = !showScreenBounds;\n\t    \tdraw();\n\t    break;\n\n\t    case 72: // h key, flip horizontal.\n\t    \tif(selectedLayer) {\n\t    \t\tswapLayerPoints(selectedLayer.sourcePoints, 0, 1);\n\t    \t\tswapLayerPoints(selectedLayer.sourcePoints, 3, 2);\n\t    \t\tupdateTransform();\n\t    \t\tdraw();\n\t    \t}\n\t    break;\n\n\t    case 86: // v key, flip vertical.\n\t    \tif(selectedLayer) {\n\t    \t\tswapLayerPoints(selectedLayer.sourcePoints, 0, 3);\n\t    \t\tswapLayerPoints(selectedLayer.sourcePoints, 1, 2);\n\t    \t\tupdateTransform();\n\t    \t\tdraw();\n\t    \t}\n\t    break;\n\n\t    case 82: // r key, rotate 90 degrees.\n\t    \tif(selectedLayer) {\n\t    \t\trotateLayer(selectedLayer, Math.PI / 2);\n\t    \t\t//rotateLayer(selectedLayer, 0.002);\n\t    \t\tupdateTransform();\n\t    \t\tdraw();\n\t    \t}\n\t    break;\n\t  }\n\n\t  // if a layer or point is selected, add the delta amounts (set above via arrow keys)\n\t  if(!showScreenBounds) {\n\t\t  if(selectedPoint) {\n\t\t    selectedPoint[0] += delta[0];\n\t\t    selectedPoint[1] += delta[1];\n\t\t    dirty = true;\n\t\t  } else if(selectedLayer) {\n\t\t  \tif(event.altKey == true) {\n\t\t\t\t\trotateLayer(selectedLayer,  delta[0] * 0.01);\n\t\t      scaleLayer(selectedLayer,  (delta[1] * -0.005) + 1.0);\n\t\t  \t} else {\n\t\t\t    for(var i = 0; i < selectedLayer.targetPoints.length; i++){\n\t\t\t      selectedLayer.targetPoints[i][0] += delta[0];\n\t\t\t      selectedLayer.targetPoints[i][1] += delta[1];\n\t\t\t    }\n\t\t\t  }\n\t\t    dirty = true;\n\t\t  }\n\t\t}\n\n\t  // update the transform and redraw if needed\n\t  if(dirty){\n\t    updateTransform();\n\t    draw();\n      if(autoSave){\n        saveSettings();\n      }\n      notifyChangeListener();\n\t  }\n\t};\n\n\tvar mouseMove = function(event) {\n\t  if(!configActive){\n\t    return;\n\t  }\n\n\t  event.preventDefault();\n\n\t  mouseDelta[0] = event.clientX - mousePosition[0];\n\t  mouseDelta[1] = event.clientY - mousePosition[1];\n\n\t  mousePosition[0] = event.clientX;\n\t  mousePosition[1] = event.clientY;\n\n\t  if(dragging) {\n\n\t    var scale = event.shiftKey ? 0.1 : 1;\n\t    \n\t    if(selectedPoint) {  \n\t      selectedPoint[0] += mouseDelta[0] * scale;\n\t      selectedPoint[1] += mouseDelta[1] * scale;\n\t    } else if(selectedLayer) {\n\t      \n\t      // Alt-drag to rotate and scale\n\t    \tif(event.altKey == true){\n\t\t      rotateLayer(selectedLayer,  mouseDelta[0] * (0.01 * scale));\n\t\t      scaleLayer(selectedLayer,  (mouseDelta[1] * (-0.005 * scale)) + 1.0);\n\t    \t} else {\n\t\t    \tfor(var i = 0; i < selectedLayer.targetPoints.length; i++){\n\t\t        selectedLayer.targetPoints[i][0] += mouseDelta[0] * scale;\n\t\t        selectedLayer.targetPoints[i][1] += mouseDelta[1] * scale;\n\t\t      }\t\n\t    \t}\n\t    }\n\n\t    updateTransform();\n      if(autoSave){\n        saveSettings();\n      }\n\t    draw();\n      notifyChangeListener();\n\n\t  } else {\n\t    var dirty = false;\n\n\t    canvas.style.cursor = 'default';\n\t    var mouseX = event.clientX;\n\t    var mouseY = event.clientY;\n\t    \n\t    var previousState = (hoveringPoint != null);\n\t    var previousLayer = (hoveringLayer != null);\n\n\t    hoveringPoint = null;\n\n\t    for(var i = 0; i < layers.length; i++) {\n\t      var layer = layers[i];\n\t      if(layer.visible){\n\t\t      for(var p = 0; p < layer.targetPoints.length; p++) {\n\t\t        var point = layer.targetPoints[p];\n\t\t        if(distanceTo(point[0], point[1], mouseX, mouseY) < selectionRadius) {\n\t\t          canvas.style.cursor = 'pointer';\n\t\t          hoveringPoint = point;\n\t\t          break;\n\t\t        }\n\t\t      }\n\t    \t}\n\t    }\n\n\t    hoveringLayer = null;\n\t    for(var i = 0; i < layers.length; i++) {\n\t      if(layers[i].visible && pointInLayer(mousePosition, layers[i])){\n\t        hoveringLayer = layers[i];\n\t        break;\n\t      }\n\t    }\n\n\t    if( showCrosshairs || \n\t        (previousState != (hoveringPoint != null)) || \n\t        (previousLayer != (hoveringLayer != null))\n\t      ) {\n\t      draw();\n\t    }\n\t  }\n\t};\n\n\tvar mouseUp = function(event) {\n\t  if(!configActive){\n\t    return;\n\t  }\n\t  event.preventDefault();\n\t  \n\t  dragging = false;\n\t};\n\n\tvar mouseDown = function(event) {\n\t  if(!configActive || showScreenBounds) {\n\t    return;\n\t  }\n\t  event.preventDefault();\n\n\t  hoveringPoint = null;\n\t  \n\t  if(hoveringLayer){\n\t    selectedLayer = hoveringLayer;\n\t    dragging = true;\n\t  } else {\n\t    selectedLayer = null;\n\t  }\n\n\t  selectedPoint = null;\n\n\t  var mouseX = event.clientX;\n\t  var mouseY = event.clientY;\n\n\t  mouseDownPoint[0] = mouseX;\n\t  mouseDownPoint[1] = mouseY;\n\n\t  for(var i = 0; i < layers.length; i++) {\n\t    var layer = layers[i];\n\t    for(var p = 0; p < layer.targetPoints.length; p++){\n\t      var point = layer.targetPoints[p];\n\t      if(distanceTo(point[0], point[1], mouseX, mouseY) < selectionRadius) {\n\t        selectedLayer = layer;\n\t        selectedPoint = point;\n\t        dragging = true;\n\t        dragOffset[0] = event.clientX - point[0];\n\t        dragOffset[1] = event.clientY - point[1];\n\t        //draw();\n\t        break;\n\t      }\n\t    }\n\t  }\n\t  draw();\n\t  return false;\n\t};\n\n\tvar addLayer = function(target, targetPoints) {\n\n\t  var element;\n\n\t  if(typeof(target) == 'string') {\n\t    element = document.getElementById(target);\n\t    if(!element) {\n\t      throw(\"Maptastic: No element found with id: \" + target);\n\t    }\n\t  } else if (target instanceof HTMLElement) {\n\t    element = target;\n\t  }\n\n    var exists = false;\n    for(var n = 0; n < layers.length; n++){\n      if(layers[n].element.id == element.id) {\n        layers[n].targetPoints = clonePoints(layout[i].targetPoints)\n        exists = true;\n      }\n    }\n\n\t  var offsetX = element.offsetLeft;\n\t  var offsetY = element.offsetTop;\n\n\t  element.style.position = 'fixed';\n\t  element.style.display = 'block';\n\t  element.style.top = '0px';\n\t  element.style.left = '0px';\n\t  element.style.padding = '0px';\n\t  element.style.margin = '0px';\n\n\t  var layer = {\n\t  \t'visible' : true,\n\t    'element' : element,\n\t    'width' : element.clientWidth,\n\t    'height' : element.clientHeight,\n\t    'sourcePoints' : [],\n\t    'targetPoints' : []\n\t  };\n\t  layer.sourcePoints.push( [0, 0], [layer.width, 0], [layer.width, layer.height], [0, layer.height]);\n\t  \n\t  if(targetPoints) {\n\t    layer.targetPoints = clonePoints(targetPoints);\n\t  } else {\n\t    layer.targetPoints.push( [0, 0], [layer.width, 0], [layer.width, layer.height], [0, layer.height]);  \n\t    for(var i = 0; i < layer.targetPoints.length; i++){\n\t      layer.targetPoints[i][0] += offsetX;\n\t      layer.targetPoints[i][1] += offsetY;\n\t    }\n\t  }\n\t  \n\t  layers.push(layer);\n\n\t  updateTransform();\n\t};\n\n  var saveSettings = function() {\n    localStorage.setItem(localStorageKey, JSON.stringify(getLayout(layers)));\n  };\n\n  var loadSettings = function() {\n    if(localStorage.getItem(localStorageKey)){\n      var data = JSON.parse(localStorage.getItem(localStorageKey));\n      \n      for(var i = 0; i < data.length; i++) {\n        for(var n = 0; n < layers.length; n++){\n          if(layers[n].element.id == data[i].id) {\n            layers[n].targetPoints = clonePoints(data[i].targetPoints);\n            layers[n].sourcePoints = clonePoints(data[i].sourcePoints);\n          }\n        }\n      }\n      updateTransform();\n    }\n  }\n\n\tvar updateTransform = function() {\n\t  var transform = [\"\", \"-webkit-\", \"-moz-\", \"-ms-\", \"-o-\"].reduce(function(p, v) { return v + \"transform\" in document.body.style ? v : p; }) + \"transform\";\n\t  for(var l = 0; l < layers.length; l++){\n\n\t    for (var a = [], b = [], i = 0, n = layers[l].sourcePoints.length; i < n; ++i) {\n\t      var s = layers[l].sourcePoints[i], t = layers[l].targetPoints[i];\n\t      a.push([s[0], s[1], 1, 0, 0, 0, -s[0] * t[0], -s[1] * t[0]]), b.push(t[0]);\n\t      a.push([0, 0, 0, s[0], s[1], 1, -s[0] * t[1], -s[1] * t[1]]), b.push(t[1]); \n\t    }\n\n\t    var X = solve(a, b, true);\n\t    var matrix = [\n\t      X[0], X[3], 0, X[6],\n\t      X[1], X[4], 0, X[7],\n\t        0,    0,  1,   0,\n\t      X[2], X[5], 0,   1\n\t    ];\n\n\t    layers[l].element.style[transform] = \"matrix3d(\" + matrix.join(',') + \")\";\n\t    layers[l].element.style[transform + \"-origin\"] = \"0px 0px 0px\";\n\t  }\n\t}\n\n\tvar setConfigEnabled = function(enabled){\n\t  configActive = enabled;\n\t  canvas.style.display = enabled ? 'block' : 'none';\n\n\t  if(!enabled) {\n\t    selectedPoint = null;\n\t    selectedLayer = null;\n\t    dragging = false;\n\t    showScreenBounds = false;\n\t  } else {\n\t    draw();\n\t  }\n\t};\n\n\tvar clonePoints = function(points){\n\t  var clone = [];\n\t  for(var p = 0; p < points.length; p++){\n\t    clone.push( points[p].slice(0,2) );\n\t  }\n\t  return clone;\n\t};\n\n\tvar resize = function() {\n\t  // viewWidth = window.innerWidth;\n\t  // viewHeight = window.innerHeight;\n\t  canvas.width = window.innerWidth;\n\t  canvas.height = window.innerHeight;\n\n\t  draw();\n\t};\n\n  var getLayout = function() {\n    var layout = [];\n    for(var i = 0; i < layers.length; i++) {\n      layout.push({\n        'id': layers[i].element.id,\n        'targetPoints': clonePoints(layers[i].targetPoints),\n        'sourcePoints': clonePoints(layers[i].sourcePoints)\n      });\n    }\n    return layout;\n  }\n\n  var setLayout = function(layout){\n    for(var i = 0; i < layout.length; i++) {\n      var exists = false;\n      for(var n = 0; n < layers.length; n++){\n        if(layers[n].element.id == layout[i].id) {\n          console.log(\"Setting points.\");\n          layers[n].targetPoints = clonePoints(layout[i].targetPoints);\n          layers[n].sourcePoints = clonePoints(layout[i].sourcePoints);\n          exists = true;\n        }\n      }\n\n      if(!exists) {\n        var element = document.getElementById(layout[i].id);\n        if(element) {\n          addLayer(element, layout[i].targetPoints);\n        } else {\n          console.log(\"Maptastic: Can't find element: \" + layout[i].id);\n        }\n      } else {\n        console.log(\"Maptastic: Element '\" + layout[i].id + \"' is already mapped.\");\n      }\n    }\n    updateTransform();\n    draw();\n  }\n\n  init();\n\n  // if the config was just an element or string, interpret it as a layer to add.\n\n  for(var i = 0; i < layerList.length; i++){\n    if((layerList[i] instanceof HTMLElement) || (typeof(layerList[i]) === 'string')) {\n      addLayer(layerList[i]);\n    }\n  }\n\n  for(var i = 0; i < arguments.length; i++){\n    if((arguments[i] instanceof HTMLElement) || (typeof(arguments[i]) === 'string')) {\n      addLayer(arguments[i]);\n    }\n  }\n\n  if(autoLoad){\n    loadSettings();\n  }\n\n  return {\n  \t'getLayout' : function() {\n\t\t  return getLayout();\n\t\t},\n\t\t'setLayout' : function(layout) {\n\t\t\tsetLayout(layout);\n\t\t},\n\t\t'setConfigEnabled' : function(enabled){\n\t\t\tsetConfigEnabled(enabled);\n\t\t},\n\t\t'addLayer' : function(target, targetPoints){\n\t\t\taddLayer(target, targetPoints);\n\t\t}\n  }\n};"]}